(()=>{"use strict";(()=>{const e=(e,t)=>e.url===t.url;window.utils={debounce:e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},shuffle:t=>{let n=[];t.forEach((t=>{n.some(e)||n.push(t)}));for(let e=n.length-1;e>0;e--){const t=Math.floor(Math.random()*e),o=n[e];n[e]=n[t],n[t]=o}return n},isEscEvent:e=>"Escape"===e.key,StatusCode:{OK:200,CREATED:201}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content.querySelector(".picture"),n=document.querySelector(".img-filters"),o=document.querySelectorAll(".img-filters__button");let s;const l=t=>{e.querySelectorAll(".picture").forEach((e=>e.remove()));let n=document.createDocumentFragment();t.forEach((e=>{const t=r(e);n.appendChild(t)})),e.appendChild(n)},r=e=>{let n=t.cloneNode(!0);return n.querySelector(".picture__img").src=e.url,n.querySelector(".picture__img").alt=e.description,n.querySelector(".picture__comments").textContent=e.comments.length,n.querySelector(".picture__likes").textContent=e.likes,n.dataset.index=e.index,n},c=(e,t)=>t.comments.length-e.comments.length,i=e=>{e.preventDefault();let t=e.target;if(t.matches(".img-filters__button"))switch(o.forEach((e=>{e.classList.remove("img-filters__button--active")})),t.classList.add("img-filters__button--active"),t.id){case"filter-random":let e=window.utils.shuffle(s).slice(0,10);l(e);break;case"filter-discussed":let t=s.slice().sort(c);l(t);break;default:l(s)}};window.gallery={photosLoadHandler:t=>{s=t,s.map(((e,t)=>{e.index=""+t})),e.addEventListener("click",(e=>{let t=e.target;if(t.matches(".picture img")){e.preventDefault();let n=t.closest(".picture").dataset.index;window.preview.open(s[n])}else if(t.matches(".picture")){e.preventDefault();let n=t.dataset.index;window.preview.open(s[n])}})),l(s),n.classList.remove("img-filters--inactive"),n.addEventListener("click",window.utils.debounce(i))}}})(),((e,t)=>{let n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{var e;n.status!==window.utils.StatusCode.OK?t("Статус ответа: "+n.status+" "+n.statusText):(e=n.response,window.gallery.photosLoadHandler(e))})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+" мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/kekstagram/data"),n.send()})(0,(e=>{let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="20px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),(()=>{const e=document.querySelector(".big-picture"),t=document.querySelector("#picture-cancel"),n=e.querySelector(".social__comments-loader"),o=e.querySelector(".big-picture__img"),s=e.querySelector(".social__caption"),l=e.querySelector(".likes-count"),r=e.querySelector(".comments-count"),c=e.querySelector(".social__comments"),i=e.querySelector(".comments-count--loaded"),a=document.querySelector("#social-comment").content.querySelector(".social__comment");let d;const u=e=>{let t=a.cloneNode(!0);t.querySelector("img").src=e.avatar,t.querySelector("img").alt=e.name,t.querySelector(".social__text").textContent=e.message;let n=document.createDocumentFragment();n.appendChild(t),c.appendChild(n)},m=()=>{let e=c.querySelectorAll(".social__comment").length;for(let t=e;t<Math.min(d.length,e+5);t++)u(d[t]);i.textContent=Math.min(d.length,e+5),d.length===c.querySelectorAll(".social__comment").length&&(n.removeEventListener("click",m),n.classList.add("hidden"))},f=e=>{window.utils.isEscEvent(e)&&v()},v=()=>{e.classList.add("hidden"),document.body.classList.remove("modal-open"),n.classList.remove("hidden"),n.removeEventListener("click",m),document.removeEventListener("keydown",f),t.removeEventListener("click",v)};window.preview={open:i=>{e.classList.remove("hidden"),document.body.classList.add("modal-open"),o.querySelector("img").src=i.url,l.textContent=i.likes,r.textContent=i.comments.length,s.textContent=i.description,c.querySelectorAll(".social__comment").forEach((e=>{e.remove()})),t.addEventListener("click",v),document.addEventListener("keydown",f),n.addEventListener("click",m),d=i.comments,m(d)}}})(),window.upload={sendData:(e,t,n)=>{let o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{o.status!==window.utils.StatusCode.OK&&o.status!==window.utils.StatusCode.CREATED?n("Статус ответа: "+o.status+" "+o.statusText):t(o.response)})),o.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),o.open("POST","https://21.javascript.pages.academy/kekstagram"),o.send(e)}},(()=>{const e=document.querySelector(".scale__control--value"),t=document.querySelector(".img-upload__preview img");let n=100;const o=(t,n)=>{t.style.transform="scale("+n/100+")",e.value=n+"%"};window.imgScale={changeValues:o,setSmallerHandler:()=>{25!==n&&(n-=25,o(t,n))},setBiggerHandler:()=>{100!==n&&(n+=25,o(t,n))}}})(),(()=>{const e=document.querySelector(".effect-level"),t=document.querySelector(".effect-level__pin"),n=document.querySelector(".effect-level__line"),o=document.querySelector(".effect-level__depth"),s=document.querySelector(".effect-level__value"),l=document.querySelector(".effects"),r=document.querySelector(".img-upload__preview img");let c;const i={chrome:{className:"effects__preview--chrome",styleFilter:e=>"grayscale("+e/100+")"},sepia:{className:"effects__preview--sepia",styleFilter:e=>"sepia("+e/100+")"},marvin:{className:"effects__preview--marvin",styleFilter:e=>"invert("+e+"%)"},phobos:{className:"effects__preview--phobos",styleFilter:e=>"blur("+3*e/100+"px)"},heat:{className:"effects__preview--heat",styleFilter:e=>"brightness("+(1+2*e/100)+")"},none:{className:"effect-preview--none",styleFilter:()=>"none"}};e.classList.add("hidden");const a=e=>{e.preventDefault();let l,a=c-e.clientX;c=e.clientX,t.offsetLeft-a<0?t.style.left="0px":t.offsetLeft-a>=n.offsetWidth?t.style.left=n.offsetWidth+"px":t.style.left=t.offsetLeft-a+"px",o.style.width=t.style.left,l=Math.round(100*t.offsetLeft/n.offsetWidth),s.value=l.toString(),r.style.filter=i[r.dataset.effect].styleFilter(l)},d=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d)};window.effects={setDefault:()=>{l.querySelector("#effect-none").checked=!0,r.className="effect-preview--none",r.style.filter="none",e.classList.add("hidden"),s.value=100..toString()},typeChangeHandler:n=>{let s=n.target;s.matches(".effects__radio")&&(o.style.width="100%",t.style.left="100%",e.classList.remove("hidden"),r.className=i[s.value].className,r.style.filter=i[s.value].styleFilter(100),r.dataset.effect=s.value,"none"===s.value&&e.classList.add("hidden"))},mouseDownHandler:e=>{e.preventDefault(),c=e.clientX,document.addEventListener("mousemove",a),document.addEventListener("mouseup",d)}}})(),(()=>{const e=/^(#)[a-zA-Zа-яА-ЯёЁ0-9]{1,19}$/i,t=["gif","jpg","jpeg","png"],n=document.querySelector("#upload-file"),o=document.querySelector("#upload-cancel"),s=document.querySelector(".img-upload__overlay"),l=document.querySelector(".img-upload__preview img"),r=document.querySelectorAll(".effects__preview"),c=document.querySelector(".text__description"),i=document.querySelector(".text__hashtags"),a=document.querySelector("#upload-select-image"),d=document.querySelector(".effects"),u=document.querySelector(".effect-level__pin"),m=document.querySelector(".scale__control--smaller"),f=document.querySelector(".scale__control--bigger"),v=document.querySelector("main"),p=()=>{n.value="",window.effects.setDefault(),window.imgScale.changeValues(l,100),i.value="",c.value="",i.setCustomValidity("")},y=()=>{s.classList.add("hidden"),document.body.classList.remove("modal-open"),p(),document.removeEventListener("keydown",w),o.removeEventListener("click",y),a.removeEventListener("submit",L),i.removeEventListener("input",g),m.removeEventListener("click",window.imgScale.setSmallerHandler),f.removeEventListener("click",window.imgScale.setBiggerHandler),u.removeEventListener("mousedown",window.effects.mouseDownHandler),d.removeEventListener("click",window.effects.typeChangeHandler)},w=e=>{!window.utils.isEscEvent(e)||i.matches(":focus")||c.matches(":focus")||document.contains(document.querySelector(".error"))||(e.preventDefault(),y())},g=()=>{let t="",n=i.value.split(/\s+/).filter((e=>" "!==e&&""!==e));n.length>5&&(t+="Не более 5 хэштегов. ");for(let o=0;o<n.length;o++)if(!e.test(n[o])){t+="Неверный формат: начинайте с # и используйте только буквы и цифры, всего до 20 символов";break}for(let e=0;e<n.length;e++)if(n.slice().map((e=>e.toLowerCase())).indexOf(n[e].toLowerCase())!==e){t+="Хэштеги не должны повторяться. ";break}i.setCustomValidity(t),i.reportValidity()},h=e=>{let t=e.cloneNode(!0),n=document.createDocumentFragment();n.appendChild(t),v.appendChild(n),t.style.zIndex="2";const o=t.querySelector("button"),s=()=>{t.remove(),document.removeEventListener("keydown",l),document.removeEventListener("click",r)},l=e=>{window.utils.isEscEvent(e)&&s()},r=e=>{e.target.matches("section")&&s()};document.addEventListener("keydown",l),document.addEventListener("click",r),o.addEventListener("click",s)},_=()=>{const e=document.querySelector("#error").content.querySelector(".error");h(e)},S=()=>{s.classList.add("hidden"),document.body.classList.remove("modal-open");const e=document.querySelector("#success").content.querySelector(".success");h(e),p()},L=e=>{window.upload.sendData(new FormData(a),S,_),e.preventDefault()};n.addEventListener("change",(()=>{s.classList.remove("hidden"),document.body.classList.add("modal-open");let e=n.files[0],c=e.name.toLowerCase();if(t.some((e=>c.endsWith(e)))){let t=new FileReader;t.addEventListener("load",(()=>{l.src=t.result,r.forEach((e=>{e.style.backgroundImage="url("+t.result+")"}))})),t.readAsDataURL(e)}document.addEventListener("keydown",w),o.addEventListener("click",y),a.addEventListener("submit",L),i.addEventListener("input",g),m.addEventListener("click",window.imgScale.setSmallerHandler),f.addEventListener("click",window.imgScale.setBiggerHandler),u.addEventListener("mousedown",window.effects.mouseDownHandler),d.addEventListener("click",window.effects.typeChangeHandler)}))})()})();